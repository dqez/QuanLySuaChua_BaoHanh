@model IEnumerable<object>

@{
    ViewData["Title"] = "Thống kê sử dụng linh kiện";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fs-1 fw-bold mb-0">Thống kê sử dụng linh kiện</h2>
    <a asp-action="Index" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Quay lại danh sách
    </a>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>Top 20 linh kiện sử dụng nhiều nhất</h5>
            </div>
            <div class="card-body">
                <canvas id="componentsChart" style="height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="statsTable">
                <thead class="table-light">
                    <tr>
                        <th>STT</th>
                        <th>Mã linh kiện</th>
                        <th>Tên linh kiện</th>
                        <th>Danh mục</th>
                        <th>Số lần sử dụng</th>
                        <th>Số lượng tồn</th>
                        <th>Chi tiết</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int index = 1;
                        foreach (dynamic item in Model)
                        {
                            <tr>
                                <td>@(index++)</td>
                                <td>@item.LinhKienId</td>
                                <td>@item.TenLinhKien</td>
                                <td>@item.DanhMuc</td>
                                <td>
                                    <span class="badge bg-primary">@item.TotalUsed</span>
                                </td>
                                <td>
                                    @item.SoLuongTon
                                    @if (item.SoLuongTon < 5)
                                    {
                                        <span class="badge bg-danger ms-2">Sắp hết</span>
                                    }
                                </td>
                                <td>
                                    <a asp-action="Details" asp-route-id="@item.LinhKienId" class="btn btn-sm btn-info">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const componentData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));
            
            const labels = componentData.map(item => item.TenLinhKien.substring(0, 20) + (item.TenLinhKien.length > 20 ? '...' : ''));
            const usageData = componentData.map(item => item.TotalUsed);
            const stockData = componentData.map(item => item.SoLuongTon);
            
            const ctx = document.getElementById('componentsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Số lần sử dụng',
                            data: usageData,
                            backgroundColor: 'rgba(49, 155, 197, 0.8)',
                            borderColor: 'rgba(49, 155, 197, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Số lượng tồn',
                            data: stockData,
                            backgroundColor: 'rgba(255, 193, 7, 0.8)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    </script>
}
